\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1, T2A]{fontenc}
\usepackage[russian]{babel}

\usepackage{amsmath,amssymb}

\usepackage{float}
\usepackage{graphicx}
\graphicspath{ {./pic/} }

\title{Байесовская деконволюция для эксперимента СФЕРА-2}

\author{Игорь Вайман}

\date{\today}

\begin{document}
	\maketitle
	
	\section{Описание эксперимента СФЕРА-2}

	Эксперимент СФЕРА-2 основан на сборе и регистрации черенковского света ШАЛ, отражённого от <<экрана>> -- ровной заснеженной поверхности льда озера Байкал. Установка представляет собой сферическое зеркало и мозаику ФЭУ, установленную вблизи фокальной поверхности. Черенковский свет ШАЛ, рассеиваясь на снегу, проходит через диафрагму установки, отражается от зеркала, и попадает на фотокатод. При попадании фотона с длиной волны в области чувствительности фотокатода с него выбиваются $1 - 10$ (уточнить) вторичных электронов, которые проходят систему динодов с разностью потенциалов между каждой парой, создавая в результате избыточный на аноде. Этот заряд стекает с анода через цепь усиления, создавая в результате напряжение на входе АЦП. Это напряжение считывается электроникой, в результате и составляя (вместе с некоторой телеметрией) экспериментальные данные.
	
	Этот набор физических процессов мы описываем в следующих предположениях:
	
	\begin{enumerate}
		\item В системе нет электронных шумов -- единственным источником шума являются фоновые фотоны (от звёздного и зодиакального света, так как эксперимент проводится в ясные безлунные ночи). Фотоны шума попадают в установку аналогично <<сигнальным>> фотонам -- после рассеяния на поверхности. Их поток можно приблизительно оценить по каталогам светимости звёзд и из моделей зодиакального света. (Ссылка на работу Энтиной)
		\item Работу ФЭУ можно эффективно описать одной <<рандомизированной>> испульсной характеристикой (РИХ). Понятие и применение РИХ будет раскрыто далее, в общем виде это случайная функция времени, описывающая отклик системы на один фотон, падающий на фотокатод. Главный источник случайности в установке СФЕРА-2 -- неопределённость числа вторичных фотонов, вылетевших с фотокатода, приводящая к неопределённости амплитуды импульса тока. Стоит отметить, что случайный характер ИХ проявляется именно на границе между режимом счёта фотонов и режимом измерения потока, поскольку поток фотонов уже слишком велик, чтобы разрешать отдельные импульсы, но недостаточно -- чтобы случайные характеристики эффективно усреднялись. Мы также предполагаем, что случайность импульсной характеристики проявлялась независимо между отдельными фотонами и между разными ФЭУ.
		\item Используя экспериментальные данные (данные, записанные АЦП, постоянную компоненту анодного тока и абсолютную калибровку ФЭУ) мы можем восстановить показания анодного тока (ссылка на работу по электронике). Неопределённость, вносимая анодной цепью, усилителем и (главным образом) дискретизацией сигнала на входе АЦП, хорошо известна и учитывается во вторую очередь.
	\end{enumerate}

	\section{Постановка задачи}
	
	\subsection{Общие допущения}
	
	Рассмотрим $N$ последовательных равновеликих временных бинов. Для простоты будем считать единицей времени длительность одного бина. Тогда мы можем задать временные бины интервалами $[i-1, i]$, $i = 1 \ldots N$. Обратим внимание, что при такой нумерации бинов эффект от фотонов, попавших в $i$-тый временной бин проявляется впервые в момент времени $i$. Обозначим число фотонов в каждом бине как $n_i$, $i = 1, \ldots, N$.

	Время прихода отдельного фотона относительно начала бина $t_{inbin} = \{ t \}$ будем описывать случайной величиной, подразумевая, что мы не интересуемся такими детальными характеристиками сигнала. Эта величина может быть, вообще говоря, распределена произвольным образом в интервале $\left[0, 1\right)$, однако мы в простейшем случае будем считать $t_{inbin} \sim U(0, 1)$. Это оправдано для независимых друг от друга фоновых фотонов, и может служить приближением для фотонов ШАЛ в случае, если дисперсия времён прихода фотонов внутри <<пакета>> сильно превышает длительность временного бина. По данным модельных ливней это не всегда так, поэтому влияние неравномерности распределения времён прихода фотонов будет исследовано отдельно.

	\begin{figure}[H]
		\centering
		\includegraphics[width=\columnwidth]{problem-setup-example}
		\caption{Пример данных для задачи байесовской деконволюции. Здесь $N = 50$, количество фотонов в каждом бине выбрано из пуассоновского распределения с $\lambda = \mathbb{E}(n_i) = 15$, они показаны синими столбцами; РИХ -- $A\exp(-t/2)$, обрезанная на $L = 10$, где случайный множитель $A \sim U(0.75, 1)$; оранжевые точки -- выходной сигнал; пунктиром показаны участки, исключаемые из рассмотрения из-за краевых эффектов.}
		\label{pic:problem-setup}
	\end{figure}

	Предположим, что импульсная характеристика системы -- случайная функция $\tilde{h}(t)$ в том смысле, что для входного сигнала, состоящего из конечного числа дельта-функций на единицу времени, каждая из этих дельта функций сворачивается с отдельной независимой реализацией $h(t) \sim \tilde{h}(t)$. Будем также считать, что любая реализация удовлетворяет условию каузальности, то есть $\forall t < 0 \; \; \forall h \sim \tilde{h} \; \; h(t) = 0$, и конечности во времени, то есть $\exists \tilde{L}$ такое, что $\forall t > \tilde{L} \; \; \tilde{h}(t) = 0$.

	Заметим, что эффект от фотонов в $i$-том бине проявляется в отсчётах c $i$ по $i + \left \lfloor{\tilde{L}}\right \rfloor$, где $\left \lfloor{\tilde{L}}\right \rfloor$ -- наибольшее целое число, не превышающее $\tilde{L}$ (округление вниз). Обозначим $L \equiv \left \lfloor{\tilde{L}}\right \rfloor$. Тогда полный сигнал от фотонов гарантированно содержится в отсчётах с $1$ по $N + L$.
	
	Таким образом, сигнал от изолированных $N$ бинов будет целиком описываться отсчётами $S_j$ в моменты времени $j = 1, \ldots, N + L$. Иллюстрация постановки задачи приведена на рис. \ref{pic:problem-setup}.
	
	\subsection{Краевые эффекты} \label{sec:edge-effects}
	
	В реальном эксперименте входные фотоны не ограничены интервалом $[0; N]$, но приходят постоянно. Модифицируем постановку задачи так, чтобы устранить краевые эффекты -- плавный рост сигнала в начале и затухание в конце.
	
	Для этого достаточно исключить из всего дальнейшего рассмотрения эти участки сигнала. Так, в реальной ситуации фотоны продолжают приходить после $t=N$, и вносят соответствующий вклад в отсчёты начиная с $N-1$. Фотоны, приходившие до $t=0$, вносят вклад в отсчёты до $L$.
	
	Поэтому для восстановления значений $n_i$, $i = 1, \ldots, N$ мы будем использовать только отсчёты $S_j$ при $j = L+1, \ldots, N$. Этот участок изображён на рис. \ref{pic:problem-setup} сплошной линией, участки по краям, исключаемые из рассмотрения -- пунктиром.
	
	
	\subsection{Байесовская деконволюция}
	
	Поставим задачу статистической деконволюции следующим образом, используя байесовскую терминологию (поэтому будем также называть эту процедуру байесовской деконволюцией):
	
	\begin{quote}
		Пусть дана рандомизированная импульсная характеристика системы $\tilde{h}(t)$ и значения $S_j, \; j = 1, \ldots, N + L$. Найти апостериорные функции плотности вероятности для значений $n_i$, $i = 1, \ldots, N$. В качестве априорного распределения $n_i$ используем наивное неограниченное однородное распределение ($p_{n_i}(x) = Const \; \forall x \in [0, \infty)$).
	\end{quote}
	
	Заметим, что, в отличие от обычной деконволюции, мы не ставим задачу оценить исходный сигнал сам по себе, представляющий собой сумму $\delta$-функций, но только его несколько обобщённую характеристику.

	\section{Решение}

	\subsection{Выходной сигнал как реализация случайного процесса}

	Дадим также несколько определений для промежуточных величин, описывающих $\{ S_j \}$ как реализацию случайного процесса.

	Очевидно, что $\{ S_j \}$ -- случайные величины, как в силу того, что РИХ в общем случае представляет собой случайную функцию, так и в силу принципиально случайного распределения фотонов внутри временного бина.
	
	Запишем $S_j$ как сумму вкладов от фотонов разных бинов
	
	\begin{equation}
		S_j = \sum_{l=0}^{L} C(n_{j-l}, l)
		\label{eq:sum_breakdown}
	\end{equation}

	Здесь $C(n, l)$ -- случайная величина, описывающая вклад в сигнал на $j$-том временном отсчёте от $n$ фотонов в бине $j - l$, иначе говоря, вклад с \textit{задержкой} $l$ бинов. Из выбранной схемы индексации бинов и условий каузальности и ограниченности во времени РИХ легко видеть, что $l \in \left[0, L\right]$.
	
	Получим распределение $C(n, l)$. Проще всего сделать это через Монте-Карло-сэмплирование её \\
	распределения. Получим сначала с произвольной точностью эмпирическую функцию плотности распределения для $C(1, l)$. Для этого сгенерируем значения $t_k \sim t_{inbin};$ и функции $h_k(t) \sim \tilde{h}(t)$ для $k = 1 \ldots N_{sample}$. Выборка для $C(1, l)$ тогда будет состоять из значений $h_k(l + 1 - t_k)$. Выборка для $C(n, l)$ легко получить, проделав описанную процедуру $n$ раз и сложив все $n$ реализаций $N_{sample}$-мерных векторов выборок.

	\subsection{Грубая оценка методом наименьших квадратов}
	
	Перед тем, как полностью решать саму задачу байесовской деконволюции, сделаем грубую оценку $\vec{n}$, зная выходной сигнал и РИХ. Для запишем систему уравнений для математических ожиданий случайных величин $S_j$.
	
	Для этого используем независимость фотонов в пределах одного бина, из чего следует $ \mathbb{E} \; C(n, l) = n \; \mathbb{E} \; C(1, l)$. Нетрудно заранее вычислить для данной РИХ выборки значений $C(1, l)$ для $l = 0 \ldots L$. Тогда получим, обозначая $c_l \equiv \mathbb{E} \; C(1, l)$,
	
	\begin{equation}
		\hat{S}_j = \mathbb{E} \; S_j = \sum_{l=0}^{L} \mathbb{E} \; C(n_{j-l}, l) = \sum_{l=0}^{L} n_{j-l} \; \mathbb{E} \; C(1, l) = \sum_{l=0}^{L} n_{j-l} c_l
	\end{equation}

	Суммирование можно записать в матричном виде для $j = 1, \ldots, N + L$:
	
	\begin{equation}
		\begin{pmatrix} 
			c_0   &  0   &  0   &\dotsm&  0     \\
			c_1   & c_0  &  0   &\dotsm&  0     \\
			c_2   & c_1  & c_0  &      & \vdots \\
			c_3   & c_2  & c_1  &\ddots&  0     \\
     	    \vdots& c_3  & c_2  &\ddots&  c_0   \\
			c_L   &\vdots& c_3  &\ddots&  c_1   \\
			0     & c_L  &\vdots&\ddots&  c_2   \\
			\vdots&      & c_L  &      &  c_3   \\
			0     &\dotsm&  0   &\ddots& \vdots \\
			0     &\dotsm& 0    &   0  &  c_L   \\
		\end{pmatrix}
		\begin{pmatrix} 
			n_1 \\ n_2 \\ n_3 \\ \vdots \\ n_N
		\end{pmatrix}
		=
		\begin{pmatrix} 
			\hat{S}_1 \\ \hat{S}_2 \\
			\vdots \\
			\hat{S}_N \\ \hat{S}_{N+1} \\
			\vdots \\
			\hat{S}_{N+L}
		\end{pmatrix}
		\label{eq:mean_matrix}
	\end{equation}

	Для перехода к случаюнепрерывного потока фотонов достаточно, как указано в разделе \ref{sec:edge-effects}, ограничиться рассмотрением строк $j = L+1, \ldots, N$, то есть убрать первые и последние $L$ уравнений системы.

	Это переопределённая система линейных уравнений, для которой можно найти решение в смысле наименьших квадратов с помощью псевдообратной матрицы Мура-Пенроуза (ссылка). Псевдообратная матрица $C^+$ для $C$ определяется следующими условиями: (1) $C C^+ C = C$, (2) $C^+ C C^+ = C^+$, (3) $C C^+$ и $C^+ C$ -- эрмитовы матрицы. Псевдообратная матрица всегда существует, и для системы $C\vec{n} = \vec{S}$ вектор $C^+ \vec{S}$ даёт искомое МНК-решение системы. Приближённый численный расчёт такой матрицы можно проводить, например, с помощью функции \verb|pinv| модуля \verb|numpy.linalg| в Python (ссылка).

	\begin{figure}[H]
		\centering
		\includegraphics[width=\columnwidth]{mean-estimation}
		\caption{Оценка $\vec{n}$ в предположении, что выходной сигнал $\vec{S}$ равен своему математическому ожиданию. Пунктиром показана область, где оценка искажена эффектом ограниченности выборки во времени.}
		\label{pic:mean-estimation}
	\end{figure}
	
	Решение системы предполагает, что нам известны $\mathbb{E} \; S_j$, в то время как в эксперименте мы имеем единственную реализацию этой случайной величины $s_j$, и принципиально не можем пропустить одни и те же фотоны через установку несколько раз. Для грубой оценки остаётся положить $\mathbb{E} \; S_j \approxeq s_j$. Результат этой процедуры приведён на рис. \ref{pic:mean-estimation} фиолетовым, пунктиром отмечена область, в которой оценка искажена краевым эффектом, её необходимо отбросить.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=\columnwidth]{mean-estimation-assessment}
		\caption{Распределения истинных и восстановленных значений $\vec{n}$ для 1000 значений. Истинные значения выбраны из пуассоновского распределения с $\lambda = 15$, как и на рис. \ref{pic:problem-setup} и \ref{pic:mean-estimation}.}
		\label{pic:mean-estimation-assessment}
	\end{figure}
	
	Строгое исследование корректности и свойств такой оценки $\vec{n}$ находится за рамками данной работы. Однако для простой численной проверки можно вычислить такую оценку для большего числа бинов и сравнить распределения истинных и оцененных значений $\vec{n}$. На рис. (!) приведено такое распределение для 1000 бинов. Видно, что распределения практически совпадают, систематический сдвиг отсутствует, а значит, метод подходит в качестве первого приближения.

	
	\subsection{Метод Монте-Карло с марковскими цепями (Markov Chain Monte Carlo)}
	
	Для решения задачи байесовской деконволюции необходимо найти апостериорное распределение вектора $\vec{n}$:
	
	
\end{document}
